# PulseEngine pipeline configuration.
#
# Full 3-gate pipeline with formal verification and integration testing
# across the meld -> loom -> synth toolchain.
#
# Copy to configs/pipeline.toml to use:
#   cp examples/pulseengine/pipeline.toml configs/pipeline.toml

[gates.quality]
description = "Gate 1: Code quality (fmt, clippy, test)"
checks = ["cargo_fmt", "cargo_clippy", "cargo_test"]
required = true

[gates.proof]
description = "Gate 2: Formal verification (Z3, Rocq)"
checks = ["z3_verify", "rocq_proofs"]
required = true

[gates.integration]
description = "Gate 3: Full pipeline integration (meld -> loom -> synth)"
fixture = "fixtures/pipeline_test.wat"
required = true

[[gates.integration.steps]]
repo = "meld"
label = "meld fuse"
args = ["fuse", "{fixture}", "-o", "{output_dir}/fused.wasm"]

[[gates.integration.steps]]
repo = "loom"
label = "loom optimize"
args = ["optimize", "{output_dir}/fused.wasm", "-o", "{output_dir}/optimized.wasm"]

[[gates.integration.steps]]
repo = "synth"
label = "synth compile"
args = ["compile", "{output_dir}/optimized.wasm", "-o", "{output_dir}/binary"]

[release]
targets = [
    "aarch64-apple-darwin",
    "x86_64-unknown-linux-gnu",
    "wasm32-wasip2",
]

[release.artifacts]
verification_report = true
proof_build_log = true
test_report = true
traceability_matrix = true
checksums = "sha256"

[budget]
ceiling_usd = 10000.0
per_session_timeout_secs = 600

[budget.allocation]
implementation_opus = 6000.0
planning_opus = 1000.0
reviews_sonnet = 1000.0
integration_sonnet = 500.0
buffer = 1500.0

[[backends]]
name = "claude-code"
type = "agent"
command = "claude"
prompt_args = ["-p", "{prompt}", "--output-format", "json"]
model = "claude-opus-4-6"
enabled = true

[[backends]]
name = "anthropic-api"
type = "chat"
provider = "anthropic"
model = "claude-sonnet-4-5-20250929"
api_key_env = "ANTHROPIC_API_KEY"
enabled = true

[roles.implementer]
backend = "opus"
prompt_template = "agents/implementer.md"
budget_usd = 6.0
timeout_secs = 600

[roles.reviewer]
backend = "sonnet"
prompt_template = "agents/reviewer.md"
budget_usd = 1.0
timeout_secs = 300

[roles.planner]
backend = "opus"
prompt_template = "agents/planner.md"
budget_usd = 1.0
timeout_secs = 300

[sandbox]
backend = "none"
memory_limit_mb = 4096
cpu_limit = 2.0
network = false

[subsample]
enabled = true
gate1_ratio = 0.3
gate2_ratio = 1.0
gate3_ratio = 1.0
seed_strategy = "task-id"
